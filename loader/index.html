<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="../dist/filer.min.js"></script>
    <script src="async.js"></script>
    <script src="notfound.js"></script>
    <script src="preprocess.js"></script>
    <script>
      var Path = Filer.Path;

      function print(s) {
        document.getElementById('output').innerHTML = s;
      }

      function Filesystem(flags) {
        var fs = this.fs = new Filer.FileSystem({
          flags: flags,
          provider: new Filer.FileSystem.providers.Fallback()
        });
        this.sh = fs.Shell();
      }
      Filesystem.prototype.install = function(url) {
        var sh = this.sh;
        sh.wget(url, function(err, path) {
          if(err) {
            return print('Error: Unable to download filesystem image `' + url + '`');
          }

          sh.unzip(path, function(err) {
            if(err) {
              return print('Error: Unable to extract filesystem image');
            }

            sh.rm(path, function(err) {
              if(err) {
                print('Warning: Unable to remove filesystem image archive `' + path + '`');
              }

              print('Installed filesystem.');
            });
          });
        });
      };
      Filesystem.prototype.load = function(path) {
        var fs = this.fs;
        var sh = this.sh;
        path = Path.resolve('/', path);

        fs.stat(path, function(err, stats) {
          if(err) {
            // 404
            document.write(notFoundHTML(path));
            return;
          }

          // If this is a dir, show a dir listing
          if(stats.isDirectory()) {
            sh.ls(path, function(err, list) {
              if(err) {
                // 404
                document.write(notFoundHTML(path));
                return;
              }
              document.write(listingHTML(path, list));
            });
            return;
          }

          function isImage(ext) {
            return ext === '.png' ||
                   ext === '.jpg' ||
                   ext === '.jpeg'||
                   ext === '.gif';
          }
          fs.readFile(path, 'utf8', function(err, data) {
            if(err) {
              return print('Error: Unable to load `' + path + '`');
            }

            // Treat images differently from other file types
            if(isImage(Path.extname(path))) {
              preprocess.image(data, path, fs);
            } else {
              preprocess.html(data, path, fs);
            }
          });
        });
      };

      function boot() {
        var fs;
        var bootOption = location.search.substring(1).split('=');
        var option = bootOption[0];
        var value = bootOption[1];

        if(option === 'format') {
          fs = new Filesystem(['FORMAT']);
          print('Formatted filesystem.');          
        } else {
          fs = new Filesystem();
        }

        if(option === 'install') {
          fs.install(value);          
        } else {
          // Treat everything after the ? as a path to be loaded
          fs.load(option);
        }
      }

      addEventListener('DOMContentLoaded', boot, false);
    </script>
  </head>
  <body>
    <div id="output"></div>
    <div>
      <h3>Filer bootloader</h3>
      <p>This page is a bootloader capable of creating a Filer filesystem,
         installing a zipped archive to that filesystem, and loading files from it.</p>

      <p>Boot options are passed on the query string. Valid options include:</p>
      <ul>
        <li><code>?install={zipfile url}</code> (e.g., <a href="?install=makerstrap-master.zip">?install=makerstrap-master.zip</a>)
        <li><code>?load={path to file in filesystem}</code> (e.g., <a href="?load=/makerstrap-master/demo/index.html">?load=/makerstrap-master/demo/index.html</a>
        <li><code>?format</code (e.g., <a href="?format">format the current fs (wipe it)</a>
      </ul>
    </div>
  </body>
</html>
